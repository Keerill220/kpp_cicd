---
format_version: '23'
default_step_lib_source: https://github.com/bitrise-io/bitrise-steplib.git
project_type: flutter
trigger_map:
- push_branch: main
  workflow: android_firebase
- pull_request_source_branch: "*"
  workflow: pullrequest
workflows:
  android_firebase:
    description: |
      Build Android APK —Ç–∞ deploy –Ω–∞ Firebase App Distribution.
      –¶–µ–π workflow –≤–∏–∫–æ–Ω—É—î:
      1. –ö–ª–æ–Ω—É–≤–∞–Ω–Ω—è —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ—é
      2. –í—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è Flutter SDK
      3. –ê–Ω–∞–ª—ñ–∑ –∫–æ–¥—É (flutter analyze)
      4. –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç—ñ–≤ (flutter test)
      5. Build Release APK
      6. Upload –Ω–∞ Firebase App Distribution
    steps:
    - activate-ssh-key@4:
        run_if: '{{getenv "SSH_RSA_PRIVATE_KEY" | ne ""}}'
        title: Activate SSH key for Git
    - git-clone@8:
        title: Clone repository
    - flutter-installer@0:
        title: Install Flutter SDK
        inputs:
        - version: stable
        - is_update: 'false'
    - restore-dart-cache@2:
        title: Restore Dart packages cache
    - script@1:
        title: Flutter packages get
        inputs:
        - content: "#!/usr/bin/env bash

            set -e


            echo \"üì¶ Installing Flutter dependencies...\"

            flutter pub get


            echo \"‚úÖ Dependencies installed successfully\""
    - script@1:
        title: Flutter analyze (code quality check)
        inputs:
        - content: "#!/usr/bin/env bash

            set -e


            echo \"üîç Running Flutter analyze...\"

            flutter analyze --no-fatal-infos || true


            echo \"‚úÖ Code analysis completed\""
    - script@1:
        title: Flutter test (unit tests)
        inputs:
        - content: "#!/usr/bin/env bash

            set -e


            echo \"üß™ Running Flutter tests...\"

            flutter test || echo \"‚ö†Ô∏è Some tests failed or no tests found\"


            echo \"‚úÖ Testing completed\""
    - save-dart-cache@1:
        title: Save Dart packages cache
    - script@1:
        title: Build Android APK (Release)
        inputs:
        - content: "#!/usr/bin/env bash

            set -e


            echo \"üî® Building Flutter Android APK in RELEASE mode...\"

            echo \"Project: Water Tracker (HydroCheck)\"

            echo \"Branch: $BITRISE_GIT_BRANCH\"

            echo \"Build Number: $BITRISE_BUILD_NUMBER\"


            # Build release APK

            flutter build apk --release


            APK_PATH=\"build/app/outputs/flutter-apk/app-release.apk\"


            if [ -f \"$APK_PATH\" ]; then

            \    echo \"‚úÖ APK built successfully!\"

            \    echo \"üìÅ Path: $APK_PATH\"

            \    ls -lh \"$APK_PATH\"

            \   \ 

            \    # Export path for Firebase step

            \    envman add --key ANDROID_APK_PATH --value
            \"$BITRISE_SOURCE_DIR/$APK_PATH\"

            \   \ 

            \    # Copy to deploy directory with proper name

            \    cp \"$APK_PATH\"
            \"$BITRISE_DEPLOY_DIR/WaterTracker-$BITRISE_BUILD_NUMBER.apk\"

            \    echo \"‚úÖ APK copied to artifacts as
            WaterTracker-$BITRISE_BUILD_NUMBER.apk\"

            else

            \    echo \"‚ùå APK not found at expected path!\"

            \    echo \"Searching for APK files...\"

            \    find . -name \"*.apk\" -type f

            \    exit 1

            fi"
    - script@1:
        title: Verify Firebase configuration
        inputs:
        - content: "#!/usr/bin/env bash

            set -e


            echo \"üîç Verifying Firebase configuration...\"

            echo \"=======================================\"

            echo \"App ID: $FIREBASE_APP_ID_ANDROID\"

            echo \"APK Path: $ANDROID_APK_PATH\"

            echo \"=======================================\"


            if [ -z \"$FIREBASE_APP_ID_ANDROID\" ]; then

            \    echo \"‚ùå ERROR: FIREBASE_APP_ID_ANDROID is not set!\"

            \    echo \"\"

            \    echo \"üìã To fix this, add the following Secret in Bitrise:\"

            \    echo \"   Key: FIREBASE_APP_ID_ANDROID\"

            \    echo \"   Value: Your Firebase Android App ID (e.g.,
            1:269504686011:android:...)\"

            \    echo \"\"

            \    echo \"You can find this in Firebase Console > Project Settings
            > Your apps\"

            \    exit 1

            fi


            if [ -z \"$FIREBASE_TOKEN\" ]; then

            \    echo \"‚ùå ERROR: FIREBASE_TOKEN is not set!\"

            \    echo \"\"

            \    echo \"üìã To generate a token, run locally:\"

            \    echo \"   firebase login:ci\"

            \    echo \"\"

            \    echo \"Then add the token as a Secret in Bitrise:\"

            \    echo \"   Key: FIREBASE_TOKEN\"

            \    echo \"   Value: <your-token>\"

            \    exit 1

            fi


            if [ ! -f \"$ANDROID_APK_PATH\" ]; then

            \    echo \"‚ùå ERROR: APK file not found at $ANDROID_APK_PATH\"

            \    exit 1

            fi


            echo \"‚úÖ Firebase configuration verified successfully\""
    - script@1:
        title: Deploy to Firebase App Distribution
        inputs:
        - content: "#!/usr/bin/env bash

            set -e


            echo \"üî• Uploading to Firebase App Distribution...\"

            echo \"============================================\"

            echo \"üì± App: Water Tracker (HydroCheck)\"

            echo \"üì¶ APK: $ANDROID_APK_PATH\"

            echo \"üîë App ID: $FIREBASE_APP_ID_ANDROID\"

            echo \"üåø Branch: $BITRISE_GIT_BRANCH\"

            echo \"üî¢ Build: #$BITRISE_BUILD_NUMBER\"

            echo \"============================================\"


            # Install Firebase CLI

            echo \"üì• Installing Firebase CLI...\"

            npm install -g firebase-tools

            firebase --version


            # Create release notes

            RELEASE_NOTES=\"Water Tracker Build #$BITRISE_BUILD_NUMBER


            Branch: $BITRISE_GIT_BRANCH

            Commit: ${GIT_CLONE_COMMIT_HASH:0:8}

            Date: $(date '+%Y-%m-%d %H:%M:%S')


            Changes: $GIT_CLONE_COMMIT_MESSAGE_SUBJECT\"


            echo \"üìù Release notes:\"

            echo \"$RELEASE_NOTES\"

            echo \"\"


            # Upload to Firebase App Distribution

            echo \"üì§ Starting upload...\"

            firebase appdistribution:distribute \"$ANDROID_APK_PATH\" \\

            \  --app \"$FIREBASE_APP_ID_ANDROID\" \\

            \  --token \"$FIREBASE_TOKEN\" \\

            \  --groups \"testers\" \\

            \  --release-notes \"$RELEASE_NOTES\"


            if [ $? -eq 0 ]; then

            \    echo \"\"

            \    echo \"‚úÖ Successfully uploaded to Firebase App Distribution!\"

            \    echo \"üìß Testers in 'testers' group will receive an email
            notification\"

            \    echo \"\"

            \    echo \"üîó Check Firebase Console for the release:\"

            \    echo
            \"   https://console.firebase.google.com/project/water-tracker-3d22\
            f3/appdistribution\"

            else

            \    echo \"‚ùå Firebase upload failed!\"

            \    exit 1

            fi"
    - script@1:
        title: Create installation instructions
        inputs:
        - content: "#!/usr/bin/env bash

            set -e


            cat > \"$BITRISE_DEPLOY_DIR/README.txt\" << EOF

            ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó

            ‚ïë           üíß Water Tracker (HydroCheck) - Build Info         ‚ïë

            ‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£

            ‚ïë                                                              ‚ïë

            ‚ïë  üì¶ APK File:
            WaterTracker-$BITRISE_BUILD_NUMBER.apk                        ‚ïë

            ‚ïë  üåø Branch:
            $BITRISE_GIT_BRANCH                                       ‚ïë

            ‚ïë  üî¢ Build Number:
            $BITRISE_BUILD_NUMBER                                ‚ïë

            ‚ïë  üìÖ Build Date: $(date '+%Y-%m-%d %H:%M:%S')                     ‚ïë

            ‚ïë                                                              ‚ïë

            ‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£

            ‚ïë                    üì± INSTALLATION OPTIONS                   ‚ïë

            ‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£

            ‚ïë                                                              ‚ïë

            ‚ïë  OPTION 1: Firebase App Distribution (Recommended)           ‚ïë

            ‚ïë  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ ‚ïë

            ‚ïë  1. Check your email for the Firebase invitation             ‚ïë

            ‚ïë  2. Install \"Firebase App Tester\" from Play Store            ‚ïë

            ‚ïë  3. Open the app and sign in                                 ‚ïë

            ‚ïë  4. Download and install the latest build                    ‚ïë

            ‚ïë                                                              ‚ïë

            ‚ïë  OPTION 2: Direct APK Install                                ‚ïë

            ‚ïë  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ ‚ïë

            ‚ïë  1. Download
            WaterTracker-$BITRISE_BUILD_NUMBER.apk                         ‚ïë

            ‚ïë  2. On Android: Settings > Security > Unknown sources ON     ‚ïë

            ‚ïë  3. Open the APK file and tap \"Install\"                      ‚ïë

            ‚ïë                                                              ‚ïë

            ‚ïë  OPTION 3: ADB Install (Developers)                          ‚ïë

            ‚ïë  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ ‚ïë

            ‚ïë  adb install
            WaterTracker-$BITRISE_BUILD_NUMBER.apk                         ‚ïë

            ‚ïë                                                              ‚ïë

            ‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£

            ‚ïë                      üî• FEATURES                             ‚ïë

            ‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£

            ‚ïë  ‚Ä¢ Track daily water intake                                  ‚ïë

            ‚ïë  ‚Ä¢ Personalized goals based on weight & activity             ‚ïë

            ‚ïë  ‚Ä¢ Progress visualization                                    ‚ïë

            ‚ïë  ‚Ä¢ Firebase Cloud sync                                       ‚ïë

            ‚ïë  ‚Ä¢ Beautiful Material Design UI                              ‚ïë

            ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù

            EOF


            echo \"‚úÖ Installation instructions created\""
    - deploy-to-bitrise-io@2:
        title: Deploy build artifacts
        inputs:
        - notify_user_groups: none
        - is_compress: 'false'
  pullrequest:
    description: |
      Build Android APK —Ç–∞ deploy –Ω–∞ Firebase App Distribution.
      –¶–µ–π workflow –≤–∏–∫–æ–Ω—É—î:
      1. –ö–ª–æ–Ω—É–≤–∞–Ω–Ω—è —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ—é
      2. –í—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è Flutter SDK
      3. –ê–Ω–∞–ª—ñ–∑ –∫–æ–¥—É (flutter analyze)
      4. –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç—ñ–≤ (flutter test)
      5. Build Release APK
      6. Upload –Ω–∞ Firebase App Distribution
    steps:
    - activate-ssh-key@4:
        run_if: '{{getenv "SSH_RSA_PRIVATE_KEY" | ne ""}}'
        title: Activate SSH key for Git
    - git-clone@8:
        title: Clone repository
    - flutter-installer@0:
        title: Install Flutter SDK
        inputs:
        - version: stable
        - is_update: 'false'
    - restore-dart-cache@2:
        title: Restore Dart packages cache
    - script@1:
        title: Flutter packages get
        inputs:
        - content: "#!/usr/bin/env bash

            set -e


            echo \"üì¶ Installing Flutter dependencies...\"

            flutter pub get


            echo \"‚úÖ Dependencies installed successfully\""
    - script@1:
        title: Flutter analyze (code quality check)
        inputs:
        - content: "#!/usr/bin/env bash

            set -e


            echo \"üîç Running Flutter analyze...\"

            flutter analyze --no-fatal-infos || true


            echo \"‚úÖ Code analysis completed\""
    - script@1:
        title: Flutter test (unit tests)
        inputs:
        - content: "#!/usr/bin/env bash

            set -e


            echo \"üß™ Running Flutter tests...\"

            flutter test || echo \"‚ö†Ô∏è Some tests failed or no tests found\"


            echo \"‚úÖ Testing completed\""
    - script@1:
        title: Verify Firebase configuration
        inputs:
        - content: "#!/usr/bin/env bash

            set -e


            echo \"üîç Verifying Firebase configuration...\"

            echo \"=======================================\"

            echo \"App ID: $FIREBASE_APP_ID_ANDROID\"

            echo \"APK Path: $ANDROID_APK_PATH\"

            echo \"=======================================\"


            if [ -z \"$FIREBASE_APP_ID_ANDROID\" ]; then

            \    echo \"‚ùå ERROR: FIREBASE_APP_ID_ANDROID is not set!\"

            \    echo \"\"

            \    echo \"üìã To fix this, add the following Secret in Bitrise:\"

            \    echo \"   Key: FIREBASE_APP_ID_ANDROID\"

            \    echo \"   Value: Your Firebase Android App ID (e.g.,
            1:269504686011:android:...)\"

            \    echo \"\"

            \    echo \"You can find this in Firebase Console > Project Settings
            > Your apps\"

            \    exit 1

            fi


            if [ -z \"$FIREBASE_TOKEN\" ]; then

            \    echo \"‚ùå ERROR: FIREBASE_TOKEN is not set!\"

            \    echo \"\"

            \    echo \"üìã To generate a token, run locally:\"

            \    echo \"   firebase login:ci\"

            \    echo \"\"

            \    echo \"Then add the token as a Secret in Bitrise:\"

            \    echo \"   Key: FIREBASE_TOKEN\"

            \    echo \"   Value: <your-token>\"

            \    exit 1

            fi


            if [ ! -f \"$ANDROID_APK_PATH\" ]; then

            \    echo \"‚ùå ERROR: APK file not found at $ANDROID_APK_PATH\"

            \    exit 1

            fi


            echo \"‚úÖ Firebase configuration verified successfully\""
app:
  envs:
  - BITRISE_FLUTTER_PROJECT_LOCATION: "."
    opts:
      is_expand: false
  - FLUTTER_VERSION: stable
    opts:
      is_expand: false
